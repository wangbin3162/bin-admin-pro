import{aF as Z,aG as W,r as M,l as N,p as q,q as G,aH as K}from"./vendor-B29aizbt.js";import{c as Q,n as F}from"./chunk-bin-ui-design-CMJ2EfEK.js";import{m as P,n as L,i as A}from"./index-C63pl2jy.js";function we(e,a=!0){const r=e.row[0],n=e.row[1],t=e.column[0],o=e.column[1];if(a){console.log("------------------------ 选区log -------------------------");const l=`开始单元格：row：${r+1} col：${t+1}`,c=`结束单元格：row：${n+1} col：${o+1}`,i=`选中单元格数量：${n-r+1}行 ${o-t+1}列`;console.log(`${l} | ${c} | ${i}`)}return{cellIndex:{row:r,column:t},cellRange:e,cellPosition:{start:`${z(t)}${r+1}`,end:`${z(o)}${n+1}`}}}const z=e=>String.fromCharCode(65+e);function O(e){if(e.length===0)return null;let a=0,r=0;if(e.length>0){if(r=B(e.charAt(0)),e.length>1){let t=e.charAt(1);Y(t)&&(r=(r+1)*26+B(t))}a=X(e)-1}return a<0||r<0?null:{row:a,column:r}}function X(e){let a=e.match(/\d+$/);return a?parseInt(a[0],10):null}function B(e){return e.charCodeAt(0)-65}function Y(e){return/^[A-Z]$/.test(e)}function J(e){let a=null,r=[],n=0,t=null,o=/MATCH\((.*?)\)/,l=e.match(o);if(l){let x=l[0],m=l[1];if(console.log("MATCH 表达式:",x),console.log("参数:",m),x&&m){const h=m.split(",");h.length===3&&(a=O(h[0]),r=$(h[1]),n=+h[2])}}else console.log("未找到 MATCH 表达式");let c=/COUNTIF\((.*?)\)/,i=e.match(c);if(i){let x=i[0],m=i[1];if(console.log("COUNTIF 表达式:",x),console.log("参数:",m),x&&m){const h=m.split(",");let I=[],R=[];h.length===2&&(I=$(h[0]),R=$(h[1]),t={keysList:I,valuesList:R})}}else console.log("未找到 COUNTIF 表达式");const y={matchCellRange:a,sourceList:r,orderIndex:n,countIf:t};return console.log(y),y}function $(e){const a=[],r=e.split(":"),n=O(r[0]),t=O(r[1]);if(n.column===t.column)for(let o=n.row;o<=t.row;o++)a.push({column:n.column,row:o});if(n.row===t.row)for(let o=n.column;o<=t.column;o++)a.push({column:o,row:n.row});return a}function ee(e){return P(e)==="object"}function te(e){return P(e)==="function"}const oe=(e,a)=>new Promise(r=>{const n=new Z.Workbook;return ee(e)&&(e=[e]),e.forEach(function(o){if(o.data.length===0)return!0;const l=n.addWorksheet(o.name),c=o.config&&o.config.merge||{},i=o.config&&o.config.borderInfo||{};return ae(o.data,l),ne(c,l),re(i,l),!0}),n.xlsx.writeBuffer().then(o=>{const l=new Blob([o],{type:"application/vnd.ms-excel;charset=utf-8"});r(),W.saveAs(l,`${a}.xlsx`)})}),ne=(e={},a)=>{Object.values(e).forEach(function(n){a.mergeCells(n.r+1,n.c+1,n.r+n.rs,n.c+n.cs)})},re=(e,a)=>{Array.isArray(e)&&e.forEach(function(r){if(r.rangeType==="range"){let n=ie(r.borderType,r.style,r.color),t=r.range[0],o=t.row,l=t.column;for(let c=o[0]+1;c<o[1]+2;c++)for(let i=l[0]+1;i<l[1]+2;i++)a.getCell(c,i).border=n}if(r.rangeType==="cell"){const{col_index:n,row_index:t}=r.value,o=Object.assign({},r.value);delete o.col_index,delete o.row_index;let l=ue(o);a.getCell(t+1,n+1).border=l}})},ae=(e,a)=>{Array.isArray(e)&&e.forEach(function(r,n){r.every(function(t,o){if(!t)return!0;let l=le(t.bg),c=se(t.ff,t.fc,t.bl,t.it,t.fs,t.cl,t.ul),i=ce(t.vt,t.ht,t.tb,t.tr),y="";t.f?y={formula:t.f,result:t.v}:!t.v&&t.ct&&t.ct.s?t.ct.s.forEach(h=>{y+=h.v}):y=t.v;let x=fe(o),m=a.getCell(x+(n+1));for(const h in l){m.fill=l;break}return m.font=c,m.alignment=i,m.value=y,!0})})},le=e=>e?{type:"pattern",pattern:"solid",fgColor:{argb:e.replace("#","")}}:{},se=(e=0,a="#000000",r=0,n=0,t=10,o=0,l=0)=>{const c={0:"微软雅黑",1:"宋体（Song）",2:"黑体（ST Heiti）",3:"楷体（ST Kaiti）",4:"仿宋（ST FangSong）",5:"新宋体（ST Song）",6:"华文新魏",7:"华文行楷",8:"华文隶书",9:"Arial",10:"Times New Roman ",11:"Tahoma ",12:"Verdana",num2bl:function(y){return y!==0}};return{name:typeof e=="number"?c[e]:e,family:1,size:t,color:{argb:a.replace("#","")},bold:c.num2bl(r),italic:c.num2bl(n),underline:c.num2bl(l),strike:c.num2bl(o)}},ce=(e="default",a="default",r="default",n="default")=>{const t={vertical:{0:"middle",1:"top",2:"bottom",default:"top"},horizontal:{0:"center",1:"left",2:"right",default:"left"},wrapText:{0:!1,1:!1,2:!0,default:!1},textRotation:{0:0,1:45,2:-45,3:"vertical",4:90,5:-90,default:0}};return{vertical:t.vertical[e],horizontal:t.horizontal[a],wrapText:t.wrapText[r],textRotation:t.textRotation[n]}},ie=(e,a=1,r="#000")=>{if(!e)return{};const n={type:{"border-all":"all","border-top":"top","border-right":"right","border-bottom":"bottom","border-left":"left"},style:{0:"none",1:"thin",2:"hair",3:"dotted",4:"dashDot",5:"dashDot",6:"dashDotDot",7:"double",8:"medium",9:"mediumDashed",10:"mediumDashDot",11:"mediumDashDotDot",12:"slantDashDot",13:"thick"}};let t={style:n.style[a],color:{argb:r.replace("#","")}},o={};return n.type[e]==="all"?(o.top=t,o.right=t,o.bottom=t,o.left=t):o[n.type[e]]=t,o};function ue(e,a,r){let n={};const t={type:{l:"left",r:"right",b:"bottom",t:"top"},style:{0:"none",1:"thin",2:"hair",3:"dotted",4:"dashDot",5:"dashDot",6:"dashDotDot",7:"double",8:"medium",9:"mediumDashed",10:"mediumDashDot",11:"mediumDashDotDot",12:"slantDashDot",13:"thick"}};for(const o in e)e[o].color.indexOf("rgb")===-1?n[t.type[o]]={style:t.style[e[o].style],color:{argb:e[o].color.replace("#","")}}:n[t.type[o]]={style:t.style[e[o].style],color:{argb:e[o].color}};return n}function fe(e){let a=65,n=90-a+1,t="";for(;e>=0;)t=String.fromCharCode(e%n+a)+t,e=Math.floor(e/n)-1;return t}const de={appversion:"",company:"",createdTime:"",creator:"",lastmodifiedby:"",modifiedTime:"",name:""};class _{constructor(){this.dft={cellIndex:{row:0,column:0},cellRange:{row:[],column:[]},cellPosition:{start:"A1",end:"A1"},fieldName:"",fieldTitle:"",dataType:"string",datasource:{type:"normal",dependOn:"",normal:"",cascade:"",fx:""},events:{enable:!1,augments:["LuckySheet","cellValue","mapping"],funcBody:""}}}getDefault(){return this.dft}getMerge(a){return L(A(this.dft),A(a))}}_.DataType={mapping:{string:"文本",number:"数值",date:"日期",select:"下拉"},options:[{key:"string",label:"文本"},{key:"number",label:"数值"},{key:"date",label:"日期"},{key:"select",label:"下拉"}]};_.DatasourceType={mapping:{normal:"普通模式",cascade:"级联模式",fx:"函数模式"}};class H{constructor(){this.dataVerification={checked:!1,hintShow:!1,hintText:"",prohibitInput:!1,remote:!1,type:"dropdown",type2:!1,value1:"",value2:""}}getDefault(){return this.dataVerification}getMerge(a){return L(A(this.dataVerification),A(a))}}const me={lang:"zh",showinfobar:!1,showtoolbar:!0,showtoolbarFormula:!0,showtoolbarData:!0,showtoolbarConfig:{undoRedo:!0,paintFormat:!0,currencyFormat:!1,percentageFormat:!1,numberDecrease:!1,numberIncrease:!1,moreFormats:!0,font:!0,fontSize:!0,bold:!0,italic:!0,strikethrough:!0,underline:!0,textColor:!0,fillColor:!0,border:!0,mergeCell:!0,horizontalAlignMode:!0,verticalAlignMode:!0,textWrapMode:!0,textRotateMode:!0,image:!1,link:!1,chart:!1,postil:!1,pivotTable:!1,function:!0,frozenMode:!0,sortAndFilter:!0,conditionalFormat:!0,dataVerification:!0,splitColumn:!1,screenshot:!1,findAndReplace:!0,protection:!0,print:!1},showsheetbar:!0,showstatisticBar:!0,showstatisticBarConfig:{view:!1},allowUpdate:!0,allowInsertRow:!0,allowInsertColumn:!0,allowDeleteRow:!0,allowDeleteColumn:!0,allowRenameSheet:!0,allowCopy:!0,allowSortRow:!0,allowStatistic:!0,allowFilter:!0,allowResize:!0},f=window.luckysheet,T=M({id:"",name:"",jsonData:[],mapping:[]}),ye=N({get:()=>T.value.mapping,set:e=>T.value.mapping=e});function be(){T.value={id:"",name:"",jsonData:[],mapping:[]}}function ve(){}function xe(e){var I,R;const a=M(!1),r=M(!1),n=M({...de,...(R=(I=T.value)==null?void 0:I.jsonData)==null?void 0:R.info}),t=N({get:()=>T.value.name,set:u=>T.value.name=u}),o=(u,d,b,s)=>{const p=A(T.value.mapping),C={r:u,c:d,oldvalue:b,newValue:s};l(C,p),c(C,p)},l=(u,d)=>{d.filter(s=>{var p;return s.dataType==="select"&&((p=s.datasource)==null?void 0:p.type)!=="normal"}).forEach(s=>{const p=s.datasource.type,C=s.datasource[p];if(p==="cascade"){const{dependOn:k}=s.datasource,g=O(k);if(g){const{row:w,column:D}=g,S=f.getCellValue(w,D),v=JSON.parse(C)[S];if(v){const E=new H().getMerge({value1:v});v.length>0?f.setDataVerification(E,{range:s.cellRange}):f.deleteDataVerification({range:s.cellRange})}}}else if(p==="fx"){const{matchCellRange:k,orderIndex:g,countIf:w}=J(C);if(w){const D={};for(let v=0;v<w.keysList.length;v++){const E=w.keysList[v],U=w.valuesList[v],V=f.getCellValue(E.row,E.column,{order:g}),j=f.getCellValue(U.row,U.column,{order:g});D[V]?D[V]+=","+j:D[V]=j}const S=f.getCellValue(k.row,k.column,{order:g});if(S&&D[S]){const v=D[S],E=new H().getMerge({value1:v});v.length>0?f.setDataVerification(E,{range:s.cellRange}):f.deleteDataVerification({range:s.cellRange})}}}})},c=(u,d)=>{const s=d.filter(w=>{var D;return w.dataType==="select"&&((D=w.events)==null?void 0:D.enable)}).findIndex(w=>w.cellIndex.row===u.r&&w.cellIndex.column===u.c);if(s<0)return;const p=d[s].events;if(!p)return;console.log("--------[cellUpdated]---------"),console.log("--------[events]:",p),console.log("--------[cellValue]:",u),console.log("--------[mapping]:",d);const{augments:C,funcBody:k}=d[s].events;new Function(...C,k)(f,u,d)},i=N(()=>L(A({...me,container:"SheetContainer",title:t.value,data:[{name:"Sheet1",index:0}],hook:{cellUpdated:o}}),A(e.cfg)));function y(){Q.confirm({type:"warning",title:"提示",message:"关闭当前页面会丢失没有保存的操作, 是否继续?"}).then(()=>{window.close()}).catch(()=>{})}function x(){te(f==null?void 0:f.destroy)&&f.destroy()}function m(){let u=document.createElement("input");u.type="file",u.onchange=d=>{const b=d.target.files;if(!b||b.length===0){F.error("No files wait for import");return}let s=b[0],C=s.name.split(".");if(C[C.length-1]!=="xlsx"){F.error("Currently only supports the import of xlsx files");return}n.value.name=s.name,r.value=!0,K.transformExcelToLucky(b[0],g=>{if(!g.sheets||g.sheets.length===0){F.error("Failed to read the content of the excel file, currently does not support xls files!");return}console.log("exportJson",g),r.value=!1,x(),f.create({...i.value,data:g.sheets,title:g.info.name,userInfo:g.info.name.creator})})},u.click()}function h(){oe(f.getAllSheets(),t.value).then(()=>{F.success("导出成功!")})}return q(()=>{var b,s;const u=T.value.id,d={...i.value};u&&(d.data=(b=T.value.jsonData)==null?void 0:b.sheets,d.title=(s=T.value.jsonData)==null?void 0:s.info.name),f.create(d)}),G(()=>{x()}),{info:n,title:t,options:i,btnLoading:a,isMaskShow:r,closePage:y,loadExcel:m,downloadExcel:h}}export{_ as M,H as O,J as a,O as c,ve as d,T as e,we as f,be as i,ye as m,xe as u};
